<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="styles/style.css" />

    <title>Santiago Villaviciosa’s page</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body class="font-custom">
    <div class="relative flex size-full min-h-screen flex-col bg-[#1C1D22] dark group/design-root overflow-x-hidden">
      <div class="layout-container flex h-full grow flex-col">
        <div class="px-4 sm:px-10 md:px-20 lg:px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex p-4 @container">
              <div class="flex w-full flex-col gap-4 md:flex-row md:justify-between md:items-center">
                <div class="flex gap-4">
                  <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-36 w-36 profile-image"></div>
                  <div class="flex flex-col justify-center">
                    <p class="text-[#F9FAFA] text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em]">Santiago Villaviciosa</p>
                    <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Engineering Team Lead</p>
                    <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Senior Software Engineer</p>
                  </div>
                </div>
                <div class="flex items-center gap-6 text-[#F9FAFA] text-xl pt-4">
                  <a href="https://github.com/santiago-vl" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition">
                    <i class="fab fa-github"></i>
                  </a>
                  <a href="https://www.linkedin.com/in/santiago-villaviciosa" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition">
                    <i class="fab fa-linkedin"></i>
                  </a>
                  <a href="mailto:santyswdev@gmail.com" class="hover:text-blue-400 transition" onclick="window.location.href='mailto:santyswdev@gmail.com'; return false;">
                    <i class="fas fa-envelope"></i>
                  </a>
                </div>
              </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex gap-6 px-4 py-6 border-b border-[#505362] mb-6 overflow-x-auto">
              <a href="#about-me" class="text-[#D5D6DD] hover:text-[#F9FAFA] text-sm sm:text-base font-medium transition whitespace-nowrap">About Me</a>
              <a href="#work-experience" class="text-[#D5D6DD] hover:text-[#F9FAFA] text-sm sm:text-base font-medium transition whitespace-nowrap">Work Experience</a>
              <a href="#personal-projects" class="text-[#D5D6DD] hover:text-[#F9FAFA] text-sm sm:text-base font-medium transition whitespace-nowrap">Personal Projects</a>
              <a href="#investments" class="text-[#D5D6DD] hover:text-[#F9FAFA] text-sm sm:text-base font-medium transition whitespace-nowrap">Investments</a>
            </nav>

            <h2 id="about-me" class="text-[#F9FAFA] text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">About Me</h2>
            <p class="text-[#F9FAFA] text-sm sm:text-base font-normal leading-normal pb-3 pt-1 px-4">
              I’m a software engineer graduated from the University of A Coruña, with over 8 years of experience. I work at <a href="https://www.inditex.com/itxcomweb/es/es/home" target="_blank" class="underline text-blue-400 hover:text-blue-300 transition">Inditex</a>, where I specialize in designing and building scalable microservices architectures based on Domain-Driven Design (DDD). I’m deeply passionate about clean code, software craftsmanship, and ensuring code quality through SOLID principles and modern engineering practices. In recent years, I’ve developed a strong interest in Artificial Intelligence and its integration into real-world systems. I lead a development team, where I not only oversee technical decisions and project delivery, but also mentor junior and mid-level developers, conduct performance evaluations, and promote best practices in engineering excellence.
            </p>
            <h2 id="work-experience" class="text-[#F9FAFA] text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Work Experience</h2>
            <div class="grid grid-cols-[40px_1fr] gap-x-2 px-4">
              <div class="flex flex-col items-center gap-1 pt-3">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-6 diverger-logo"></div>
                <div class="w-[1.5px] bg-[#505362] h-2 grow"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">Engineering Team Lead | Senior Software Engineer at Diverger</p>
                <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Mar. 2024 - Present · 1 año 2 meses</p>
              </div>
              <div class="flex flex-col items-center gap-1">
                <div class="w-[1.5px] bg-[#505362] h-2"></div>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-6 inditex-logo"></div>
                <div class="w-[1.5px] bg-[#505362] h-2 grow"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">Software Engineer at Inditex</p>
                <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Jan. 2019 - Present · 6 años 4 meses</p>
              </div>
              <div class="flex flex-col items-center gap-1">
                <div class="w-[1.5px] bg-[#505362] h-2"></div>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-6 trileuco-logo"></div>
                <div class="w-[1.5px] bg-[#505362] h-2 grow"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">Software Engineer at Trileuco Solutions</p>
                <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Apr. 2018 - Mar. 2024 · 6 años</p>
              </div>
              <div class="flex flex-col items-center gap-1">
                <div class="w-[1.5px] bg-[#505362] h-2"></div>
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-6 indra-logo"></div>
              </div>
              <div class="flex flex-1 flex-col py-3">
                <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">Software Engineer at Indra</p>
                <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">Feb. 2017 - Dec. 2017 · 11 meses</p>
              </div>
            </div>
            <h2 id="personal-projects" class="text-[#F9FAFA] text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Personal Projects</h2>
            <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-4">
              <div class="flex flex-col gap-3 pb-3">
                <div class="relative">
                  <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl translAIt-image"></div>
                  <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-semibold px-2 py-1 rounded">Upcoming Release</div>
                </div>
                <div>
                  <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">TranslAIt</p>
                  <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">A web application that allows users to upload audio files and transcribe them using AI-powered speech recognition.</p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div class="relative">
                  <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl neuralWaves-image"></div>
                  <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-semibold px-2 py-1 rounded">WIP</div>
                </div>
                <div>
                  <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">NeuralWaves</p>
                  <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">
                    A web-based platform powered by AI models to deliver precise beach wave forecasts, specially designed for surfers.
                  </p>
                </div>
              </div>
              <div class="flex flex-col gap-3 pb-3">
                <div class="relative">
                  <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl midinova-image"></div>
                  <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-semibold px-2 py-1 rounded">WIP</div>
                </div>
                <div>
                  <p class="text-[#F9FAFA] text-sm sm:text-base font-medium leading-normal">Midinova</p>
                  <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal">
                    AI-powered web platform that automates liquidity allocation into NASDAQ-100 index funds, using macroeconomic indicators and sentiment analysis.
                  </p>
                </div>
              </div>
            </div>
            <h2 id="investments" class="text-[#F9FAFA] text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Investments</h2>
            <section aria-labelledby="investments">
            <div class="px-4 pb-3 pt-1">
              <p class="text-[#F9FAFA] text-sm sm:text-base font-normal leading-normal">
                I'm passionate about investing and this is my current portfolio, diversified across different sectors:
              </p>
            </div>

            <!-- Charts Grid -->
            <div class="investments-charts-grid px-4 pb-8">
              <div class="chart-container">
                <h3 class="chart-title">By Sector</h3>
                <canvas id="chart-by-category" aria-label="Distribution of investments by sector"></canvas>
              </div>
              <div class="chart-container">
                <h3 class="chart-title">Assets & Sectors</h3>
                <canvas id="chart-nested" aria-label="Nested distribution of assets and sectors"></canvas>
              </div>
              <div class="chart-container full-width">
                <h3 class="chart-title">Monthly DCA Contributions by Asset</h3>
                <canvas id="chart-horizontal-bar" aria-label="Portfolio monthly DCA ordered by asset"></canvas>
              </div>
            </div>

            <!-- Investments Table -->
            <div class="investments-table-wrapper px-4 pb-8">
              <table class="investments-table" aria-label="Investment portfolio details by asset">
                <thead>
                  <tr>
                    <th>Sector</th>
                    <th>Asset</th>
                    <th>%</th>
                    <th>ISIN</th>
                  </tr>
                </thead>
                <tbody id="investments-table-body">
                  <!-- Generated by JS -->
                </tbody>
              </table>
            </div>

            <!-- Performance Projection Section -->
            <div class="px-4 py-8">
              <h3 class="text-[#F9FAFA] text-lg sm:text-xl font-bold leading-tight tracking-[-0.015em] mb-3">5-Year Performance Projection</h3>
              <p class="text-[#D5D6DD] text-sm sm:text-base font-normal leading-normal mb-6">
                Projected portfolio growth with €500 initial investment + €500 monthly contributions based on historical returns (2019-2024):
              </p>

              <div class="performance-chart-container mb-6">
                <canvas id="performance-chart" aria-label="5-year portfolio performance projection"></canvas>
              </div>

              <div class="performance-stats grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="stat-box bg-[#2d2d3e] rounded-lg p-4 border border-[#505362]">
                  <p class="text-[#D5D6DD] text-xs font-medium mb-1">Total Contributed</p>
                  <p class="text-[#F9FAFA] text-lg sm:text-xl font-bold">€30,500</p>
                </div>
                <div class="stat-box bg-[#2d2d3e] rounded-lg p-4 border border-[#505362]">
                  <p class="text-[#D5D6DD] text-xs font-medium mb-1">Projected (5yr)</p>
                  <p class="text-[#F9FAFA] text-lg sm:text-xl font-bold" id="projected-value">—</p>
                </div>
                <div class="stat-box bg-[#2d2d3e] rounded-lg p-4 border border-[#505362]">
                  <p class="text-[#D5D6DD] text-xs font-medium mb-1">Total Gain</p>
                  <p class="text-[#F9FAFA] text-lg sm:text-xl font-bold" id="total-return">—</p>
                </div>
                <div class="stat-box bg-[#2d2d3e] rounded-lg p-4 border border-[#505362]">
                  <p class="text-[#D5D6DD] text-xs font-medium mb-1">Gain %</p>
                  <p class="text-[#F9FAFA] text-lg sm:text-xl font-bold" id="annual-avg">—</p>
                </div>
              </div>

              <p class="text-[#505362] text-xs font-normal mb-4" id="data-source">
                Loading data from Finnhub API...
              </p>
            </div>

            </section>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Investments Script -->
    <script>
      // === INVESTMENT DATA ===
      const investments = [
        { sector: "AI",            name: "Nvidia",                              amount: 70,  isin: "US67066G1040" },
        { sector: "AI",            name: "Amazon",                              amount: 50,  isin: "US0231351067" },
        { sector: "AI",            name: "ASML Holding",                        amount: 55,  isin: "NL0010273215" },
        { sector: "AI",            name: "Microsoft",                           amount: 50,  isin: "US5949181045" },
        { sector: "AI",            name: "Alphabet (Class A)",                  amount: 20,  isin: "US02079K3059" },
        { sector: "AI",            name: "Meta Platforms",                      amount: 20,  isin: "US30303M1027" },
        { sector: "AI",            name: "Apple",                               amount: 20,  isin: "US0378331005" },
        { sector: "AI",            name: "Tesla",                               amount: 20,  isin: "US88160R1014" },
        { sector: "CYBERSECURITY", name: "Palo Alto Networks",                  amount: 20,  isin: "US6974351057" },
        { sector: "CYBERSECURITY", name: "Global X Defence Tech UCITS ETF",     amount: 20,  isin: "IE00JCW3DZ3" },
        { sector: "CYBERSECURITY", name: "Palantir Technologies",               amount: 20,  isin: "US69608A1088" },
        { sector: "ROBOTICS",      name: "Intuitive Surgical",                  amount: 20,  isin: "US46120E6023" },
        { sector: "PHARMA",        name: "Eli Lilly",                           amount: 20,  isin: "US5324571083" },
        { sector: "LUXURY",        name: "Hermès International",                amount: 20,  isin: "FR0000052292" },
        { sector: "GOLD",          name: "iShares Physical Gold ETC",           amount: 100, isin: "IE00B4ND3602" },
        { sector: "UTILITIES",     name: "Iberdrola",                           amount: 50,  isin: "ES0144580Y14" },
        { sector: "FINIZENS",      name: "Finizens Investment Plan — Index Funds", amount: 100, isin: "N/A" },
        { sector: "FINIZENS",      name: "Finizens Pension Plan — Index Funds",   amount: 100, isin: "N/A" },
      ];

      const TOTAL_MONTHLY = 775;

      // === SOPHISTICATED COLOR PALETTE ===
      const sectorColors = {
        "AI": "#3B82F6",
        "CYBERSECURITY": "#8B5CF6",
        "ROBOTICS": "#06B6D4",
        "PHARMA": "#10B981",
        "LUXURY": "#D4AF37",
        "GOLD": "#F59E0B",
        "UTILITIES": "#6366F1",
        "FINIZENS": "#EC4899",
      };

      // === HELPER FUNCTIONS ===
      function getSectorColor(sector) {
        return sectorColors[sector] || "#6B7280";
      }

      function groupBySector(data) {
        const grouped = {};
        data.forEach((item) => {
          if (!grouped[item.sector]) {
            grouped[item.sector] = 0;
          }
          grouped[item.sector] += item.amount;
        });
        return grouped;
      }

      function sortByAmount(data) {
        return [...data].sort((a, b) => b.amount - a.amount);
      }

      // === RENDER TABLE ===
      function renderTable() {
        const tbody = document.getElementById("investments-table-body");
        const sorted = sortByAmount(investments);

        tbody.innerHTML = sorted
          .map((item) => {
            const percentage = ((item.amount / TOTAL_MONTHLY) * 100).toFixed(1);
            const colorBox = `<span class="category-color-box" style="background-color: ${getSectorColor(item.sector)}"></span>`;

            return `
              <tr>
                <td>${colorBox} ${item.sector}</td>
                <td>${item.name}</td>
                <td>${percentage}%</td>
                <td>${item.isin}</td>
              </tr>
            `;
          })
          .join("");
      }

      // === CHART.JS: DONUT BY SECTOR ===
      function initChartByCategory() {
        const ctx = document.getElementById("chart-by-category").getContext("2d");
        const grouped = groupBySector(investments);
        const labels = Object.keys(grouped);
        const data = Object.values(grouped);
        const colors = labels.map(getSectorColor);

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: colors,
                borderColor: "#1C1D22",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: "#D5D6DD",
                  font: { family: "'Manrope', sans-serif", size: 12 },
                  padding: 15,
                },
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: ${percentage}%`;
                  },
                },
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#F9FAFA",
                bodyColor: "#D5D6DD",
              },
            },
          },
        });
      }

      // === CHART.JS: NESTED DOUGHNUT (ASSETS + SECTORS) ===
      function initChartNested() {
        const ctx = document.getElementById("chart-nested").getContext("2d");

        // Outer ring: assets
        const assetLabels = investments.map((a) => a.name);
        const assetAmounts = investments.map((a) => a.amount);
        const assetColors = investments.map((a) => getSectorColor(a.sector));

        // Inner ring: sectors (summary)
        const sectorLabels = Object.keys(groupBySector(investments));
        const sectorAmounts = sectorLabels.map(
          (sec) =>
            investments
              .filter((a) => a.sector === sec)
              .reduce((sum, a) => sum + a.amount, 0)
        );
        const sectorColorsInner = sectorLabels.map(getSectorColor);

        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [...assetLabels, ...sectorLabels],
            datasets: [
              {
                label: "Assets",
                data: [...assetAmounts, ...Array(sectorAmounts.length).fill(0)],
                backgroundColor: [...assetColors, ...Array(sectorAmounts.length).fill("transparent")],
                borderColor: "#1C1D22",
                borderWidth: 2,
              },
              {
                label: "Sectors",
                data: [...Array(assetAmounts.length).fill(0), ...sectorAmounts],
                backgroundColor: [...Array(assetAmounts.length).fill("transparent"), ...sectorColorsInner],
                borderColor: "#1C1D22",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: "#D5D6DD",
                  font: { family: "'Manrope', sans-serif", size: 10 },
                  padding: 10,
                  boxWidth: 8,
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#F9FAFA",
                bodyColor: "#D5D6DD",
              },
            },
          },
        });
      }

      // === CHART.JS: HORIZONTAL BAR ===
      function initChartHorizontalBar() {
        const ctx = document.getElementById("chart-horizontal-bar").getContext("2d");
        const sorted = sortByAmount(investments);
        const labels = sorted.map((a) => a.name);
        const data = sorted.map((a) => a.amount);
        const colors = sorted.map((a) => getSectorColor(a.sector));

        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Monthly €",
                data,
                backgroundColor: colors,
                borderColor: "#1C1D22",
                borderWidth: 1,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#F9FAFA",
                bodyColor: "#D5D6DD",
                callbacks: {
                  label: (context) => {
                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                    return `${percentage}%`;
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: "#505362", drawBorder: false },
                ticks: { color: "#D5D6DD" },
              },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#D5D6DD", font: { size: 9 } },
              },
            },
          },
        });
      }

      // === INTERSECTION OBSERVER FOR ANIMATIONS ===
      function initAnimations() {
        const observerOptions = {
          threshold: 0.1,
          rootMargin: "0px 0px -50px 0px",
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("animate-in");
            } else {
              entry.target.classList.remove("animate-in");
            }
          });
        }, observerOptions);

        document.querySelectorAll(".investments-table-wrapper, .chart-container").forEach((el) => {
          observer.observe(el);
        });
      }

      // === PERFORMANCE PROJECTION ===
      const API_KEY = "d456b8hr01qsugt8t9ggd456b8hr01qsugt8t9h0";
      const FINNHUB_BASE = "https://finnhub.io/api/v1";

      // Fallback data: historical CAGR for key assets (2019-2024)
      const fallbackCAGR = {
        "NVDA": 0.35,    // 35% annual (AI sector)
        "PLTR": 0.18,    // 18% (Cybersecurity)
        "ISRG": 0.15,    // 15% (Robotics)
        "LLY": 0.25,     // 25% (Pharma)
        "GLD": 0.05,     // 5% (Gold)
        "IBE": 0.08,     // 8% (Utilities)
        "FINIZENS": 0.15 // 15% (estimated for private fund)
      };

      // Portfolio mapping (normalized weights summing to 1.0)
      const portfolioMapping = [
        { symbol: "NVDA", sector: "AI", weight: 0.404 },
        { symbol: "PLTR", sector: "CYBERSECURITY", weight: 0.079 },
        { symbol: "ISRG", sector: "ROBOTICS", weight: 0.027 },
        { symbol: "LLY", sector: "PHARMA", weight: 0.027 },
        { symbol: "GLD", sector: "GOLD", weight: 0.132 },
        { symbol: "IBE", sector: "UTILITIES", weight: 0.067 },
        { symbol: "FINIZENS", sector: "FINIZENS", weight: 0.265 }
      ];

      async function fetchHistoricalData(symbol) {
        try {
          // Fetch last 60 months of data
          const response = await fetch(
            `${FINNHUB_BASE}/stock/candle?symbol=${symbol}&resolution=M&count=60&token=${API_KEY}`
          );

          if (!response.ok) throw new Error(`API error: ${response.status}`);

          const data = await response.json();

          if (!data.c || data.c.length < 2) {
            throw new Error(`Insufficient data for ${symbol}`);
          }

          return data.c; // Return closing prices array
        } catch (error) {
          console.warn(`Could not fetch ${symbol}, using fallback:`, error);
          return null;
        }
      }

      function calculateCAGR(prices) {
        if (!prices || prices.length < 2) return null;

        const startPrice = prices[0];
        const endPrice = prices[prices.length - 1];
        const years = prices.length / 12; // Convert months to years

        if (startPrice <= 0) return null;

        const cagr = Math.pow(endPrice / startPrice, 1 / years) - 1;
        return Math.max(cagr, 0); // Avoid negative returns for this projection
      }

      async function getCAGRForAsset(symbol) {
        // Try to fetch real data first
        const prices = await fetchHistoricalData(symbol);

        if (prices) {
          const cagr = calculateCAGR(prices);
          if (cagr !== null) return cagr;
        }

        // Fallback to predefined CAGR
        return fallbackCAGR[symbol] || 0.10;
      }

      function projectPortfolioValue(initialValue, monthlyContribution, cagrBySymbol, months) {
        // Calculate weighted average CAGR
        let weightedCAGR = 0;
        portfolioMapping.forEach(({ symbol, weight }) => {
          const cagr = cagrBySymbol[symbol] || fallbackCAGR[symbol];
          weightedCAGR += cagr * weight;
        });

        // Convert annual CAGR to monthly rate
        const monthlyRate = Math.pow(1 + weightedCAGR, 1 / 12) - 1;

        // Project portfolio month by month
        const projectedValues = [initialValue];
        let totalValue = initialValue;

        for (let month = 1; month <= months; month++) {
          // Grow previous value + add monthly contribution
          totalValue = totalValue * (1 + monthlyRate) + monthlyContribution;
          projectedValues.push(Math.round(totalValue));
        }

        return projectedValues;
      }

      async function initPerformanceProjection() {
        const sourceEl = document.getElementById("data-source");
        const initialValue = 500;
        const monthlyContribution = 500;
        const totalContributed = initialValue + (monthlyContribution * 60);

        try {
          sourceEl.textContent = "Loading data from Finnhub API...";

          // Fetch CAGR for all symbols
          const cagrBySymbol = {};

          for (const { symbol } of portfolioMapping) {
            cagrBySymbol[symbol] = await getCAGRForAsset(symbol);
          }

          // Project 60 months with monthly contributions
          const projectedValues = projectPortfolioValue(initialValue, monthlyContribution, cagrBySymbol, 60);

          // Render chart
          initPerformanceChart(projectedValues);

          // Update stats
          const finalValue = projectedValues[projectedValues.length - 1];
          const totalGain = finalValue - totalContributed;
          const gainPercent = ((totalGain / totalContributed) * 100).toFixed(1);

          document.getElementById("projected-value").textContent = `€${finalValue.toLocaleString()}`;
          document.getElementById("total-return").textContent = `€${totalGain.toLocaleString()}`;
          document.getElementById("annual-avg").textContent = `+${gainPercent}%`;

          sourceEl.textContent = "✓ Data from Finnhub API (2019-2024 historical returns projected)";
          sourceEl.classList.add("text-green-400");
        } catch (error) {
          console.error("Performance projection error:", error);

          // Fallback: use default CAGR values
          const fallbackCAGRBySymbol = { ...fallbackCAGR };
          const projectedValues = projectPortfolioValue(initialValue, monthlyContribution, fallbackCAGRBySymbol, 60);

          initPerformanceChart(projectedValues);

          const finalValue = projectedValues[projectedValues.length - 1];
          const totalGain = finalValue - totalContributed;
          const gainPercent = ((totalGain / totalContributed) * 100).toFixed(1);

          document.getElementById("projected-value").textContent = `€${finalValue.toLocaleString()}`;
          document.getElementById("total-return").textContent = `€${totalGain.toLocaleString()}`;
          document.getElementById("annual-avg").textContent = `+${gainPercent}%`;

          sourceEl.textContent = "⚠ Estimated projection (API unavailable, using historical averages)";
          sourceEl.classList.add("text-yellow-600");
        }
      }

      function initPerformanceChart(projectedValues) {
        const ctx = document.getElementById("performance-chart").getContext("2d");
        const months = projectedValues.map((_, i) => i);

        new Chart(ctx, {
          type: "line",
          data: {
            labels: months,
            datasets: [
              {
                label: "Portfolio Value (€)",
                data: projectedValues,
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: "#3B82F6",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: "#D5D6DD",
                  font: { family: "'Manrope', sans-serif", size: 12 },
                  padding: 15,
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                titleColor: "#F9FAFA",
                bodyColor: "#D5D6DD",
                callbacks: {
                  label: (context) => {
                    return `€${context.parsed.y.toLocaleString()}`;
                  },
                  title: (context) => {
                    return `Month ${context[0].label}`;
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Months",
                  color: "#D5D6DD",
                },
                grid: { color: "#505362", drawBorder: false },
                ticks: { color: "#D5D6DD" },
              },
              y: {
                title: {
                  display: true,
                  text: "Portfolio Value (€)",
                  color: "#D5D6DD",
                },
                grid: { color: "#505362", drawBorder: false },
                ticks: {
                  color: "#D5D6DD",
                  callback: (value) => "€" + value.toLocaleString(),
                },
              },
            },
          },
        });
      }

      // === INICIALIZACIÓN ===
      document.addEventListener("DOMContentLoaded", () => {
        renderTable();
        initChartByCategory();
        initChartNested();
        initChartHorizontalBar();
        initAnimations();
        initPerformanceProjection();
      });
    </script>
  </body>
</html>
